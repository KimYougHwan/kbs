<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.kbs.distribute.mapper.menu.MenuMapper">
	<select id="selectLoginMenuList" parameterType="String"	resultType="loginMenuVo">
		SELECT
			TT.MENU_CODE, TT.CLASS_FG, TT.SUB_CNT, TT.PAGE_URL, TT.PAGE_NM,
			TT.CODE_GRUP_1, TT.CODE_GRUP_2, TT.CODE_GRUP_3, TT.PRIV_CODE
		FROM(
			SELECT 
				CONCAT(CODE_GRUP_3,CODE_ITEM,'0000') AS MENU_CODE,
				'0' AS CLASS_FG,
				(SELECT COUNT(*) FROM MENU_PRIV_CODE
					WHERE SUBSTR(MENU_CODE,1,4) = CONCAT(A.CODE_GRUP_3,A.CODE_ITEM)
					AND	PRIV_CODE = #{privCode}
				) AS SUB_CNT,
				MEMO AS PAGE_URL,
				CODE_ITEM_NAME AS PAGE_NM,
				CODE_ITEM AS CODE_GRUP_1 ,
				'00' AS CODE_GRUP_2 ,
				'00' AS CODE_GRUP_3 ,
				(SELECT PRIV_CODE FROM MENU_PRIV_CODE WHERE PRIV_CODE = #{privCode} AND MENU_CODE =CONCAT(CODE_GRUP_3,CODE_ITEM,'0000') ) AS PRIV_CODE ,
				ORDER_NO
			FROM COMM_CODE A
			WHERE CODE_GRUP_1 = '00'
			AND CODE_GRUP_2 = '00'
			AND CODE_GRUP_3 = '03'
			AND USE_YN ='Y'
		
			UNION ALL
			
			SELECT 
				A.MENU_CODE , A.CLASS_FG,
				IFNULL(B.SUB_CNT,0),
				A.PAGE_URL,	A.PAGE_NM,
				CODE_GRUP_3 AS CODE_GRUP_1, CODE_ITEM AS CODE_GRUP_2,
				'00' AS CODE_GRUP_3, PRIV_CODE,	ORDER_NO
			FROM(
				SELECT 
					CONCAT(CODE_GRUP_2,CODE_GRUP_3,CODE_ITEM,'00') MENU_CODE,
					'1' CLASS_FG, MEMO PAGE_URL, CODE_ITEM_NAME PAGE_NM,
					CODE_GRUP_1, CODE_GRUP_2, CODE_GRUP_3, CODE_ITEM, PRIV_CODE, ORDER_NO
				FROM COMM_CODE AS A
				LEFT JOIN
				(
					SELECT 
						PRIV_CODE ,
						MENU_CODE ,
						BUTN_CODE
					FROM MENU_PRIV_CODE
					WHERE PRIV_CODE = #{privCode}
				) B
				ON (
					CONCAT(CODE_GRUP_2, CODE_GRUP_3, CODE_ITEM,'00')
				) = B.MENU_CODE
				WHERE CODE_GRUP_1 = '00'
				AND CODE_GRUP_2 = '03'

			) A
			LEFT JOIN
			(
				SELECT 
					CONCAT(CODE_GRUP_1, CODE_GRUP_2, CODE_GRUP_3, '00') MENU_CODE,
					'1' CLASS_FG, COUNT(B.PRIV_CODE) SUB_CNT
				FROM COMM_CODE A
				LEFT JOIN
				(
					SELECT 
						PRIV_CODE, MENU_CODE, BUTN_CODE
					FROM MENU_PRIV_CODE
					WHERE PRIV_CODE = #{privCode}
				) B
				ON (
					CONCAT(CODE_GRUP_1, CODE_GRUP_2, CODE_GRUP_3, CODE_ITEM)
				) = B.MENU_CODE
				WHERE CODE_GRUP_1 = '03'
				AND MEMO != ''
				GROUP BY CODE_GRUP_1, CODE_GRUP_2, CODE_GRUP_3
			) B
			ON (
				A.MENU_CODE = B.MENU_CODE
			)
		
			UNION ALL
			
			SELECT 
				CONCAT(CODE_GRUP_1, CODE_GRUP_2, CODE_GRUP_3,CODE_ITEM) MENU_CODE,
				'2' CLASS_FG, 0 SUB_CNT, MEMO PAGE_URL,	CODE_ITEM_NAME PAGE_NM,
				CODE_GRUP_2 AS CODE_GRUP_1, CODE_GRUP_3 AS CODE_GRUP_2,	CODE_ITEM AS CODE_GRUP_3,
				PRIV_CODE, ORDER_NO
			FROM COMM_CODE AS A
			JOIN
			(
				SELECT 
					PRIV_CODE, MENU_CODE, BUTN_CODE
				FROM MENU_PRIV_CODE
				WHERE PRIV_CODE = #{privCode}
			) B
			ON (
				CONCAT(CODE_GRUP_1, CODE_GRUP_2, CODE_GRUP_3, CODE_ITEM)
			) = B.MENU_CODE
			WHERE CODE_GRUP_1 = '03'
		) TT
		WHERE PRIV_CODE = #{privCode}
		ORDER BY TT.CODE_GRUP_1,
      	TT.CODE_GRUP_2
	</select>

</mapper>